<ng-container *ngIf="ticketFound; else missingTicket">
  <ng-container *ngIf="ticket$ | async as ticket; else loadingTicket">
    <section class="ticket-details-wrapper">
      <div class="ticket-hero mat-elevation-z3">
        <div class="hero-text">
          <span class="hero-eyebrow">Ticket #{{ ticket.id }}</span>
          <h1 class="hero-title">{{ ticket.title }}</h1>
          <p class="hero-meta">
            Created {{ ticket.created_at | date: 'mediumDate' }}
            <ng-container *ngIf="ticket.updated_at">
              · Updated {{ ticket.updated_at | date: 'medium' }}
            </ng-container>
          </p>
        </div>
        <div class="hero-chips">
          <app-priority-badge [priority]="ticket.priority"></app-priority-badge>
          <app-status-label [status]="ticket.status"></app-status-label>
        </div>

        <ng-container *ngIf="canUpdateTicket()">
          <div class="hero-actions">
            <p class="hero-actions-label">Update progress</p>
            <div class="hero-actions-buttons">
              <button
                mat-stroked-button
                color="primary"
                type="button"
                class="status-action-button progress-action-button"
                *ngFor="let action of progressActions"
                [disabled]="ticket.status === action.status || statusUpdateInFlight === action.status"
                (click)="updateTicketStatus(ticket.id, action.status)"
              >
                <mat-icon *ngIf="statusUpdateInFlight !== action.status">{{ action.icon }}</mat-icon>
                <mat-icon class="spinning-icon" *ngIf="statusUpdateInFlight === action.status">autorenew</mat-icon>
                {{ action.label }}
              </button>
            </div>
          </div>

          <div class="hero-actions hero-assign">
            <p class="hero-actions-label">Assignment</p>
            <div class="hero-actions-buttons">
              <button
                mat-stroked-button
                color="accent"
                type="button"
                class="status-action-button assign-action-button"
                [disabled]="assignInFlight || !currentUser"
                (click)="toggleAssignee(ticket.id, ticket.assignee_id)"
              >
                <mat-icon *ngIf="!assignInFlight">
                  {{ ticket.assignee_id === currentUser?.id ? 'person_remove' : 'person_add' }}
                </mat-icon>
                <mat-icon class="spinning-icon" *ngIf="assignInFlight">autorenew</mat-icon>
                {{ ticket.assignee_id === currentUser?.id ? 'Unassign' : 'Assign to me' }}
              </button>
              <span class="hero-assign-note" *ngIf="currentUser">
                Current assignee: {{ ticket.assignee_id || 'Unassigned' }}
              </span>
            </div>
          </div>
        </ng-container>
      </div>

      <div class="details-grid">
        <mat-card class="detail-card glass-card description-card">
          <mat-card-content>
            <div class="section-heading">
              <div class="heading-icon">
                <mat-icon>description</mat-icon>
              </div>
              <div>
                <p class="section-eyebrow">Full Description</p>
                <h2>Conversation &amp; context</h2>
              </div>
              <button type="button" class="ghost-pill" aria-label="Copy description">
                <mat-icon>content_copy</mat-icon>
                Copy
              </button>
            </div>

            <div class="ticket-description">
              {{ ticket.description || 'No description provided.' }}
            </div>

            <div class="ticket-meta-grid">
              <div class="meta-card">
                <span class="meta-label">Assignee</span>
                <span class="meta-value">{{ ticket.assignee_id || 'Unassigned' }}</span>
              </div>
              <div class="meta-card">
                <span class="meta-label">Creator</span>
                <span class="meta-value">#{{ ticket.creator_id }}</span>
              </div>
              <div class="meta-card">
                <span class="meta-label">External User</span>
                <span class="meta-value">{{ (externalUserInfo$ | async)?.name || 'N/A' }}</span>
              </div>
            </div>

            <div class="ticket-tags">
              <span class="meta-label">Tags</span>
              <mat-chip-set *ngIf="ticket.tags?.length; else noTags">
                <mat-chip *ngFor="let tag of ticket.tags">{{ tag }}</mat-chip>
              </mat-chip-set>
              <ng-template #noTags><span class="muted-text">No tags</span></ng-template>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="detail-card glass-card status-history-card">
          <mat-card-content>
            <div class="section-heading">
              <div class="heading-icon">
                <mat-icon>timeline</mat-icon>
              </div>
              <div>
                <p class="section-eyebrow">Status History</p>
                <h2>Journey so far</h2>
              </div>
            </div>

            <div class="status-timeline" *ngIf="ticket.status_changes?.length; else timelineFallback">
              <div class="timeline-item" *ngFor="let change of ticket.status_changes; let idx = index">
                <div class="timeline-icon" [ngClass]="{ accent: idx === 0 }">
                  <mat-icon>{{ idx === 0 ? 'flag_circle' : 'sync_alt' }}</mat-icon>
                </div>
                <div class="timeline-content">
                  <p class="timeline-title">
                    {{ change.old_status | titlecase }}
                    <span class="arrow">→</span>
                    {{ change.new_status | titlecase }}
                  </p>
                  <div class="timeline-value">
                    <app-status-label [status]="change.new_status"></app-status-label>
                  </div>
                  <span class="timeline-timestamp">
                    {{ change.changed_at | date: 'medium' }}
                  </span>
                </div>
              </div>
            </div>
            <ng-template #timelineFallback>
              <p class="muted-text">No historical changes recorded for this ticket yet.</p>
            </ng-template>
          </mat-card-content>
        </mat-card>

        <mat-card class="detail-card glass-card triage-card ai-card">
          <mat-card-content>
            <div class="section-heading ai-heading">
              <div class="heading-icon sparkle">
                <mat-icon>auto_awesome</mat-icon>
              </div>
              <div>
                <p class="section-eyebrow">AI Triage</p>
                <h2>Aurora assistant</h2>
              </div>
            </div>

            <ng-container *ngIf="(currentUserRole$ | async) as role">
              <ng-container *ngIf="role === UserRole.Agent || role === UserRole.Admin; else triageReadonly">
                <ng-container *ngIf="triageSuggestion as suggestion; else triageActions">
                  <div class="suggestion-details">
                    <div class="suggestion-field">
                      <span class="meta-label">Status</span>
                      <app-status-label [status]="suggestion.suggested_status"></app-status-label>
                    </div>
                    <div class="suggestion-field">
                      <span class="meta-label">Priority</span>
                      <app-priority-badge [priority]="suggestion.suggested_priority"></app-priority-badge>
                    </div>
                    <div class="suggestion-field">
                      <span class="meta-label">Suggested tags</span>
                      <mat-chip-set *ngIf="suggestion.suggested_tags.length; else noSuggestedTags">
                        <mat-chip *ngFor="let tag of suggestion.suggested_tags">{{ tag }}</mat-chip>
                      </mat-chip-set>
                      <ng-template #noSuggestedTags><span class="muted-text">None</span></ng-template>
                    </div>
                  </div>
                  <div class="triage-actions">
                    <button
                      mat-raised-button
                      type="button"
                      class="gradient-pill"
                      (click)="acceptTriageSuggestion(ticket.id)"
                    >
                      <mat-icon>check_circle</mat-icon>
                      Accept
                    </button>
                    <button
                      mat-raised-button
                      type="button"
                      class="gradient-pill outline"
                      (click)="loadTriageSuggestion(ticket.id)"
                    >
                      <mat-icon>refresh</mat-icon>
                      Refresh
                    </button>
                    <button mat-button type="button" class="link-button" (click)="rejectTriageSuggestion()">
                      Dismiss
                    </button>
                  </div>
                </ng-container>
                <ng-template #triageActions>
                  <p class="muted-text">
                    Need a fresh recommendation? Let Aurora analyze the ticket details for you.
                  </p>
                  <button
                    mat-raised-button
                    type="button"
                    class="gradient-pill"
                    (click)="loadTriageSuggestion(ticket.id)"
                  >
                    <mat-icon>auto_fix_high</mat-icon>
                    Generate Suggestion
                  </button>
                </ng-template>
              </ng-container>
            </ng-container>
            <ng-template #triageReadonly>
              <p class="muted-text">Only agents and admins can manage triage suggestions.</p>
            </ng-template>
          </mat-card-content>
        </mat-card>
      </div>
    </section>

    <div class="actions">
      <button mat-button (click)="goBack()">Go Back</button>
    </div>
  </ng-container>
</ng-container>

<ng-template #loadingTicket>
  <div class="loading-state">
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  </div>
</ng-template>

<ng-template #missingTicket>
  <mat-card class="ticket-card not-found-card">
    <mat-card-title>Ticket Not Found</mat-card-title>
    <mat-card-content>
      <p>We could not find the requested ticket.</p>
      <button mat-button (click)="goBack()">Go Back</button>
    </mat-card-content>
  </mat-card>
</ng-template>
