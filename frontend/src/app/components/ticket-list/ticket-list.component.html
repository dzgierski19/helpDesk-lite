<form class="filter-form" [formGroup]="filterForm" (ngSubmit)="applyFilters()">
  <div class="filter-controls">
    <mat-form-field appearance="fill">
      <mat-label>Status</mat-label>
      <mat-select formControlName="status">
        <mat-option [value]="null">All statuses</mat-option>
        <mat-option *ngFor="let status of statusOptions" [value]="status">
          {{ status | titlecase }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Priority</mat-label>
      <mat-select formControlName="priority">
        <mat-option [value]="null">All priorities</mat-option>
        <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
          {{ priority | titlecase }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill" class="tag-field">
      <mat-label>Tag</mat-label>
      <input matInput placeholder="Search by tag" formControlName="tag" />
    </mat-form-field>

    <button mat-flat-button color="primary" type="submit">
      <mat-icon>tune</mat-icon>
      Filter
    </button>
  </div>
</form>

<mat-progress-bar
  *ngIf="isLoading$ | async"
  color="accent"
  mode="indeterminate"
></mat-progress-bar>

<ng-container *ngIf="tickets$ | async as tickets">
  <div class="ticket-list-container" *ngIf="tickets.length; else emptyState">
    <div class="desktop-view">
      <table mat-table [dataSource]="tickets" class="ticket-table mat-elevation-z2">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let ticket">{{ ticket.id }}</td>
        </ng-container>

        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Title</th>
          <td mat-cell *matCellDef="let ticket">{{ ticket.title }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let ticket">
            <app-status-label [status]="ticket.status"></app-status-label>
          </td>
        </ng-container>

        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef>Priority</th>
          <td mat-cell *matCellDef="let ticket">
            <app-priority-badge [priority]="ticket.priority"></app-priority-badge>
          </td>
        </ng-container>

        <ng-container matColumnDef="assignee_id">
          <th mat-header-cell *matHeaderCellDef>Assignee</th>
          <td mat-cell *matCellDef="let ticket">{{ ticket.assignee_id ?? 'Unassigned' }}</td>
        </ng-container>

        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let ticket">{{ ticket.created_at | date: 'medium' }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let ticket">
            <button mat-icon-button (click)="viewTicket(ticket.id)" aria-label="View ticket">
              <mat-icon>visibility</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>

    <div class="mobile-view">
      <app-ticket-card
        *ngFor="let ticket of tickets"
        [ticket]="ticket"
        [userRole]="userRole"
        (viewDetails)="viewTicket($event)"
      ></app-ticket-card>
    </div>
  </div>

  <ng-template #emptyState>
    <div class="empty-state mat-elevation-z1">
      <mat-icon>inbox</mat-icon>
      <p>No tickets found.</p>
    </div>
  </ng-template>
</ng-container>
