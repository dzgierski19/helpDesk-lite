<section class="create-ticket" *ngIf="showCreateForm">
  <form class="create-form" [formGroup]="createForm" (ngSubmit)="submitCreateForm()">
    <mat-form-field appearance="fill">
      <mat-label>Title</mat-label>
      <input matInput type="text" formControlName="title" placeholder="Short summary" />
      <mat-error *ngIf="createForm.get('title')?.hasError('required')">Title is required</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill" class="description-field">
      <mat-label>Description</mat-label>
      <textarea matInput rows="3" formControlName="description" placeholder="Describe the issue"></textarea>
      <mat-error *ngIf="createForm.get('description')?.hasError('required')">Description is required</mat-error>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Priority</mat-label>
      <mat-select formControlName="priority">
        <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
          {{ priority | titlecase }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Status</mat-label>
      <mat-select formControlName="status">
        <mat-option *ngFor="let status of statusOptions" [value]="status">
          {{ status | titlecase }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Assignee ID</mat-label>
      <input matInput type="number" formControlName="assignee_id" placeholder="Optional" />
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Tags (comma separated)</mat-label>
      <input matInput type="text" formControlName="tags" placeholder="api, mobile" />
    </mat-form-field>

    <div class="create-actions">
      <button mat-stroked-button type="button" (click)="toggleCreateForm()">Cancel</button>
      <button mat-raised-button color="primary" type="submit">Create Ticket</button>
    </div>
  </form>
</section>

<form class="filter-form" [formGroup]="filterForm" (ngSubmit)="applyFilters()">
  <div class="filter-controls">
    <mat-form-field appearance="fill">
      <mat-label>Status</mat-label>
      <mat-select formControlName="status">
        <mat-option [value]="null">All statuses</mat-option>
        <mat-option *ngFor="let status of statusOptions" [value]="status">
          {{ status | titlecase }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Priority</mat-label>
      <mat-select formControlName="priority">
        <mat-option [value]="null">All priorities</mat-option>
        <mat-option *ngFor="let priority of priorityOptions" [value]="priority">
          {{ priority | titlecase }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill" class="tag-field">
      <mat-label>Tag</mat-label>
      <input matInput placeholder="Search by tag" formControlName="tag" />
    </mat-form-field>

    <button mat-flat-button color="primary" type="submit" class="filter-submit">
      <mat-icon>tune</mat-icon>
      Filter
    </button>
  </div>
</form>

<mat-progress-bar
  *ngIf="isLoading$ | async"
  color="accent"
  mode="indeterminate"
></mat-progress-bar>

<ng-container *ngIf="tickets$ | async as tickets">
  <div class="ticket-list-container" *ngIf="tickets.length; else emptyState">
    <div class="desktop-view">
      <table mat-table [dataSource]="tickets" class="ticket-table mat-elevation-z2">
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>#</th>
          <td mat-cell *matCellDef="let ticket">{{ ticket.id }}</td>
        </ng-container>

        <ng-container matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Title</th>
          <td mat-cell *matCellDef="let ticket">{{ ticket.title }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>Status</th>
          <td mat-cell *matCellDef="let ticket">
            <app-status-label [status]="ticket.status"></app-status-label>
          </td>
        </ng-container>

        <ng-container matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef>Priority</th>
          <td mat-cell *matCellDef="let ticket">
            <app-priority-badge [priority]="ticket.priority"></app-priority-badge>
          </td>
        </ng-container>

        <ng-container matColumnDef="assignee_id">
          <th mat-header-cell *matHeaderCellDef>Assignee</th>
          <td mat-cell *matCellDef="let ticket">{{ ticket.assignee_id ?? 'Unassigned' }}</td>
        </ng-container>

        <ng-container matColumnDef="created_at">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let ticket">{{ ticket.created_at | date: 'medium' }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let ticket">
            <button
              mat-raised-button
              type="button"
              class="gradient-pill view-details-button"
              (click)="viewTicket(ticket.id)"
              aria-label="View ticket"
            >
              <mat-icon>visibility</mat-icon>
              <span>View Details</span>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>

    <div class="mobile-view">
      <app-ticket-card
        *ngFor="let ticket of tickets"
        [ticket]="ticket"
        [userRole]="userRole"
        (viewDetails)="viewTicket($event)"
      ></app-ticket-card>
    </div>
  </div>

  <ng-template #emptyState>
    <div class="empty-state mat-elevation-z1">
      <mat-icon>inbox</mat-icon>
      <p>No tickets found.</p>
    </div>
  </ng-template>
</ng-container>
