commands:
  backend:make-migrations:
    prompt: |
      As a Laravel developer, your task is to generate the necessary database migration files based on the provided `project_spec.md`.
      The database used is PostgreSQL.

      {{file "project_spec.md"}}

      You need to create or modify three migration files for the following models: `User`, `Ticket`, and `TicketStatusChange`.

      **1. Users Table Migration (Modify existing):**
         - Modify the existing `create_users_table` migration to add a `role` column.
         - `role`: enum with values `admin`, `agent`, `reporter`. This column should be added after the `password` column.

      **2. Tickets Table Migration (New file):**
         - Create a new migration file for the `tickets` table.
         - Fields:
           - `id`: primary key, auto-increment.
           - `title`: string (255), required.
           - `description`: text, required.
           - `priority`: enum with values `low`, `medium`, `high`.
           - `status`: enum with values `new`, `in_progress`, `resolved`.
           - `assignee_id`: integer, nullable, foreign key to `users.id`.
           - `creator_id`: integer, required, foreign key to `users.id`.
           - `tags`: json.
           - `created_at`: timestamp.
           - `updated_at`: timestamp.
         - Ensure foreign key constraints are correctly defined.

      **3. TicketStatusChanges Table Migration (New file):**
         - Create a new migration file for the `ticket_status_changes` table.
         - Fields:
           - `id`: primary key, auto-increment.
           - `ticket_id`: integer, foreign key to `tickets.id`.
           - `old_status`: enum with values `new`, `in_progress`, `resolved`.
           - `new_status`: enum with values `new`, `in_progress`, `resolved`.
           - `changed_at`: timestamp.
         - Ensure foreign key constraints are correctly defined.

      Place all generated migration files in the `backend/database/migrations/` directory.
      Provide the full PHP code for each migration file.
  backend:make-models:
    prompt: |
      As a Laravel developer, your task is to generate the necessary Eloquent Model files based on the provided `project_spec.md`.
      The database used is PostgreSQL.

      {{file "project_spec.md"}}

      You need to create or modify three Eloquent Model files: `User.php`, `Ticket.php`, and `TicketStatusChange.php`.

      **1. User Model (Modify existing `User.php`):**
         - Add `role` to the `$casts` property, casting it as a string enum. The enum values are `admin`, `agent`, `reporter`.
         - Define a `ticketsCreated()` relationship: a user can create many tickets (hasMany `Ticket` where `creator_id` is the foreign key).
         - Define a `ticketsAssigned()` relationship: a user can be assigned many tickets (hasMany `Ticket` where `assignee_id` is the foreign key).

      **2. Ticket Model (Create `Ticket.php`):**
         - Define the `$fillable` property to allow mass assignment for `title`, `description`, `priority`, `status`, `assignee_id`, `creator_id`, `tags`.
         - Define the `$casts` property for:
           - `priority`: cast as a string enum (`low`, `medium`, `high`).
           - `status`: cast as a string enum (`new`, `in_progress`, `resolved`).
           - `tags`: cast as `array` (Laravel will handle JSON serialization/deserialization).
         - Define a `assignee()` relationship: a ticket belongs to an `assignee` (belongsTo `User`, using `assignee_id`).
         - Define a `creator()` relationship: a ticket belongs to a `creator` (belongsTo `User`, using `creator_id`).
           - Define a `statusChanges()` relationship: a ticket has many `TicketStatusChange` records (hasMany `TicketStatusChange`).

      **3. TicketStatusChange Model (Create `TicketStatusChange.php`):**
         - Define the `$fillable` property to allow mass assignment for `ticket_id`, `old_status`, `new_status`.
         - Define the `$casts` property for:
           - `old_status`: cast as a string enum (`new`, `in_progress`, `resolved`).
           - `new_status`: cast as a string enum (`new`, `in_progress`, `resolved`).
           - `changed_at`: cast as `datetime`.
         - Define a `ticket()` relationship: a status change belongs to a `Ticket` (belongsTo `Ticket`).

      Place all generated model files in the `backend/app/Models/` directory.
      Provide the full PHP code for each model file.
  backend:make-seeders:
    prompt: |
      As a Laravel developer, your task is to create database seeders based on the provided `project_spec.md` and the existing Enum files.
      The database used is PostgreSQL.

      {{file "project_spec.md"}}
      {{file "backend/app/Enums/UserRole.php"}}
      {{file "backend/app/Enums/TicketPriority.php"}}
      {{file "backend/app/Enums/TicketStatus.php"}}

      Your task is to populate the `run` method of the main `DatabaseSeeder.php` file.

      **Instructions:**

      1.  **Create Users:**
          - Create exactly three users using the `User` model factory.
          - One user for each role defined in the `UserRole` enum (`admin`, `agent`, `reporter`).
          - Use the `UserRole` enum when setting the role.
          - Use a static password like 'password' for all users.
          - Store the created 'reporter' user in a variable for later use.

      2.  **Create Tickets:**
          - Create at least 5 sample tickets using the `Ticket` model factory.
          - For the `creator_id` of all tickets, use the ID of the 'reporter' user you created above.
          - For the `assignee_id`, you can randomly assign the 'admin' or 'agent' user, or leave it null on some tickets.
          - Use the `TicketStatus` and `TicketPriority` enums for the `status` and `priority` fields.
          - For the `tags` field, provide a sample JSON array of strings (e.g., `['api', 'bug']`).
          - Use Faker for realistic titles and descriptions.

      3.  **Update DatabaseSeeder:**
          - Ensure the `run()` method in `backend/database/seeders/DatabaseSeeder.php` contains all the logic to create these users and tickets.
          - Do not add any logic to truncate or refresh the database; just the creation logic.

      Provide the full, updated PHP code for the `backend/database/seeders/DatabaseSeeder.php` file.
  backend:make-controllers:
    prompt: |
      As a Laravel developer, your task is to generate the necessary API routes and a controller based on the provided `project_spec.md`, existing Enum files, and Model files.
      The database used is PostgreSQL.

      {{file "project_spec.md"}}
      {{file "backend/app/Enums/UserRole.php"}}
      {{file "backend/app/Enums/TicketPriority.php"}}
      {{file "backend/app/Enums/TicketStatus.php"}}
      {{file "backend/app/Models/User.php"}}
      {{file "backend/app/Models/Ticket.php"}}
      {{file "backend/app/Models/TicketStatusChange.php"}}

      You need to create a `TicketController.php` and modify `api.php` to define the API endpoints.

      **1. Create `TicketController.php` (`backend/app/Http/Controllers/TicketController.php`):**
         - Implement methods for all CRUD operations for tickets (`index`, `store`, `show`, `update`, `destroy`).
         - Implement `triageSuggest(Request $request, Ticket $ticket)` method.
         - Implement `externalUserInfo()` method.

         **Specific Logic for Controller Methods:**
         - **`index(Request $request)`:**
           - Retrieve tickets, applying filters by `status`, `priority`, `assignee_id`, and `tag` from the request query parameters.
           - **Authorization Logic:** If the `X-USER-ROLE` header is 'reporter', filter tickets to show only those where `creator_id` matches the ID of the reporter user (assume reporter user ID is 3, as per our seeding plan). Otherwise, return all tickets.
           - Return tickets as a JSON response.
         - **`store(Request $request)`:**
           - Validate incoming request data for `title`, `description`, `priority`, `status`, `assignee_id`, `tags`.
           - Create a new `Ticket` instance.
           - Set `creator_id` based on the `X-USER-ROLE` header (assume reporter user ID is 3).
           - Return the created ticket as a JSON response.
         - **`show(Ticket $ticket)`:**
           - Return the specified `Ticket` instance.
           - Ensure the `assignee` relationship is loaded (e.g., `Ticket::with('assignee')->findOrFail($id)`).
         - **`update(Request $request, Ticket $ticket)`:**
           - Validate incoming request data.
           - If the `status` field is being updated and its value changes, create a new `TicketStatusChange` record.
           - Update the `Ticket` instance.
           - Return the updated ticket as a JSON response.
         - **`destroy(Ticket $ticket)`:**
           - Delete the specified `Ticket` instance.
           - Return a success response (e.g., 204 No Content).
         - **`triageSuggest(Request $request, Ticket $ticket)`:**
           - Return the hardcoded JSON response as specified in `project_spec.md`: `{"suggested_status": "in_progress", "suggested_priority": "high", "suggested_tags": ["triage", "auto"]}`.
         - **`externalUserInfo()`:**
           - Make an HTTP GET request to `https://jsonplaceholder.typicode.com/users/1`.
           - Cache the response for 10 minutes.
           - Extract and return only the `name` from the external API response.
           - Handle potential HTTP request errors (e.g., network issues, API down) by returning `{"error": "external_api_failed"}`.

      **2. Modify `api.php` (`backend/routes/api.php`):**
         - Define API routes for all methods in `TicketController`.
         - Use `Route::apiResource` for the standard CRUD operations.
         - Define specific routes for `POST /tickets/{id}/triage-suggest` and `GET /external/user-info`.
         - Ensure routes are accessible without explicit authentication middleware for now, as per `project_spec.md` (fake login).

      Provide the full PHP code for `backend/app/Http/Controllers/TicketController.php` and `backend/routes/api.php`.
  backend:refactor-controller:
    prompt: |
      As a Laravel developer, your task is to refactor the existing `TicketController.php` to eliminate hard-coded user IDs and replace them with a dynamic, database-driven approach.

      **Context Files:**
      {{file "backend/app/Http/Controllers/TicketController.php"}}
      {{file "backend/app/Models/User.php"}}
      {{file "backend/app/Enums/UserRole.php"}}

      **Problem:**
      The current `TicketController.php` uses a hard-coded constant `REPORTER_USER_ID` and a `resolveCreatorId` method with hard-coded IDs (1, 2, 3). This is brittle and will break if the database seed order changes.

      **Refactoring Instructions:**

      1.  **Remove Hard-Coded Logic:**
          - Delete the `private const REPORTER_USER_ID = 3;` constant.
          - Delete the `private function resolveCreatorId(...)` method.

      2.  **Create a Dynamic Helper Method:**
          - Create a new private helper method, for example, `getUserIdByRole(UserRole $role): ?int`.
          - This method should accept a `UserRole` enum case.
          - It should query the `users` table to find the ID of the first user with that role (e.g., `User::where('role', $role)->value('id')`).
          - **Important:** Cache the result of this query for 1 minute to improve performance and avoid hitting the database on every request for the same role. The cache key should be dynamic based on the role (e.g., `user_id_for_role_{$role->value}`).

      3.  **Update the `index` Method:**
          - In the authorization logic for reporters, replace the hard-coded ID with a call to your new helper method: `$query->where('creator_id', $this->getUserIdByRole(UserRole::Reporter));`.

      4.  **Update the `store` Method:**
          - In the logic for setting `creator_id`, replace the call to `resolveCreatorId`.
          - The `creator_id` should be determined by finding the user ID for the 'reporter' role. For this MVP, we can assume the creator is always the main reporter. Use your new helper method: `$this->getUserIdByRole(UserRole::Reporter)`.

      Provide the full, refactored PHP code for the `backend/app/Http/Controllers/TicketController.php` file.