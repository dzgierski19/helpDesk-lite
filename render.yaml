# render.yaml v3 - Corrected Structure
# This file configures the deployment of the Helpdesk-Lite application on Render.com.

version: "1"

# Define services for web servers and workers
services:
  # Backend Service: Laravel Application
  - type: web
    name: helpdesk-backend
    runtime: php
    rootDir: backend
    buildCommand: |
      composer install --no-dev --optimize-autoloader
      php artisan config:cache
      php artisan route:cache
      php artisan view:cache
      php artisan migrate:fresh --seed --force
    startCommand: php artisan serve --host 0.0.0.0 --port $PORT
    envVars:
      - key: APP_URL
        fromService:
          type: web
          name: helpdesk-backend
          property: url
      - key: APP_ENV
        value: production
      - key: APP_DEBUG
        value: false
      - key: APP_KEY
        generateValue: true
      - key: DB_CONNECTION
        value: pgsql
      - key: DB_HOST
        fromService:
          type: psql
          name: helpdesk-db
          property: host
      - key: DB_PORT
        fromService:
          type: psql
          name: helpdesk-db
          property: port
      - key: DB_DATABASE
        fromService:
          type: psql
          name: helpdesk-db
          property: database
      - key: DB_USERNAME
        fromService:
          type: psql
          name: helpdesk-db
          property: user
      - key: DB_PASSWORD
        fromService:
          type: psql
          name: helpdesk-db
          property: password

# Define a static site for the frontend
static_site:
  name: helpdesk-frontend
  rootDir: frontend
  envVars:
    - key: NODE_VERSION
      value: "18"
    - key: BACKEND_URL
      fromService:
        type: web
        name: helpdesk-backend
        property: url
  buildCommand: |
    # Replace the placeholder in the production environment file with the actual backend URL.
    sed -i "s|%%API_URL%%|${BACKEND_URL}/api|g" src/environments/environment.prod.ts
    npm install
    npm run build -- --configuration production
  staticPublishPath: dist/frontend
  routes:
    - type: rewrite
      source: /*
      destination: /index.html

# Define the database
databases:
  # PostgreSQL Database Service
  - name: helpdesk-db
    databaseName: helpdesk_db
    user: helpdesk_user
    plan: free